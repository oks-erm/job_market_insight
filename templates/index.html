<!DOCTYPE html>
<html>

<head>
    <title>Job Search</title>
    <link rel="stylesheet" href="static/css/style.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <h1>Job Search Results</h1>
    <div id="searchFormContainer">
        <form id="searchForm">
            <label for="keywords">Keywords:</label>
            <input type="text" id="keywordsInput" name="keywords" required>
            <br>
            <label for="location">Location:</label>
            <input type="text" id="locationInput" name="location" required>
            <br>
            <button type="submit">Search</button>
        </form>
    </div>
    <div id="loader" style="display: none;">
        <div class="loading">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
    <div id="resultsContainer" style="display: none;">
        <p>Location: <span id="location"></span></p>
        <p>Keyword: <span id="keywords"></span></p>
    </div>
    <div id="plotContainer" style="display: none;">
        <h2>Top Skills Plot:</h2>
        <div id="plot"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function updatePlot() {
            // Get the form values
            let keywords = $('#keywordsInput').val();
            let location = $('#locationInput').val();

            // Show the loader
            $('#loader').show();
            $('#resultsContainer').hide();
            $('#plotContainer').hide();
            $('#plot').empty(); // Clear the previous plot

            // Send AJAX request to the Flask backend
            $.ajax({
                url: '/search',
                type: 'GET',
                data: { keywords: keywords, location: location },
                success: function (data) {
                    // Hide the loader and show the results container
                    $('#loader').hide();
                    $('#resultsContainer').show();
                    // Display the results and plot
                    $('#location').text(location);
                    $('#keywords').text(keywords);

                    let jsonData = JSON.parse(data.plot_json);
                    Plotly.newPlot('plot', jsonData.data, jsonData.layout);
                    $('#plotContainer').show();
                },
                error: function () {
                    $('#loader').hide();
                    alert('An error occurred while searching for jobs.');
                }
            });
        }

        // Function to fetch the updated plot 
        function fetchUpdatedPlot() {
            $.ajax({
                url: '/search',
                type: 'GET',
                success: function (data) {
                    if (data.plot_json) {
                        $('#loader').hide();
                        $('#resultsContainer').show();
                        let jsonData = JSON.parse(data.plot_json);
                        // Update the existing plot
                        Plotly.react('plot', jsonData.data, jsonData.layout);
                        $('#plotContainer').show();
                    } else {
                        setTimeout(fetchUpdatedPlot, 3000); 
                    }
                },
                error: function () {
                    $('#loader').hide();
                    alert('An error occurred while fetching the updated plot.');
                }
            });
        }
            
        // Handle the search form submission
        $('#searchForm').submit(function (event) {
            event.preventDefault(); 
            updatePlot();
            // Start fetching the updated plot data periodically
            setTimeout(fetchUpdatedPlot, 1000); 
        });
    </script>

</body>

</html>

