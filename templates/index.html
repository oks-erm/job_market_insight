<!DOCTYPE html>
<html>

<head>
    <title>Job Search</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div class="header-wrapper">
        <div id="header">
            <div class="logo"></div>
            <h1>IT Job Market Insights</h1>
        </div>
        <div>
            <p class="lead">Explore IT jobs market trends in Europe, the USA and the UK.</p>
        </div>
    </div>
    
    <div id="searchFormContainer">
        <form id="searchForm">
            <label for="keywordsInput">Job Title:</label>
            <input type="text" id="keywordsInput" placeholder="Job Title" name="jobs" required>
            <label for="locationInput">Location:</label>
            <input type="text" id="locationInput" placeholder="Location" name="location" required>
            <br>
            <button type="submit">Explore</button>
        </form>
    </div>
    <div id="loader" style="display: none;">
        <div id="progressMessage">
            Fetching the freshest data, meanwhile you can check recent visualisations.<br> They are pretty accurate and will be updated automatically when the freshest data is gathered.
        </div>
        <div id="progressBarContainer">
            <div class="progress progress-infinite">
                <div class="progress-bar3">
                </div>
            </div>
        </div>
    </div>
    <div id="visualizationMessage" style="display: none;">
        We're currently preparing your visualizations. Please hold on, they'll be ready soon.
    </div>
    <div id="noDataMessage" style="display: none;">
        Seems there's no data for this request.
    </div>
    <div id="topSkillsPlotContainer" style="display: none;">
        <!-- <h2>Top Skills:</h2> -->
        <div id="topSkillsPlot"></div>
    </div>
    <div id="topCitiesPlotContainer" style="display: none;">
        <!-- <h2>Top Cities:</h2> -->
        <div id="topCitiesPlot"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        function populateAutocompleteInputs() {
                $.get("/get-available-data", function (data) {
                    let jobs = data.available_jobs;
                    let locations = data.available_locations;

                    $('#keywordsInput').autocomplete({
                        source: jobs
                    });
                    $('#locationInput').autocomplete({
                        source: locations
                    });
                });
            }

        $(document).ready(function () {
                populateAutocompleteInputs();
                let socket = io();

                socket.on('connect', function () {
                    socket.emit('my event', { data: 'I\'m connected!' });

                    $('#searchForm').submit(function (event) {
                        event.preventDefault();
                        showLoader();

                        // Clear the plots
                        $('#topSkillsPlotContainer').hide();
                        $('#topCitiesPlotContainer').hide();

                        let keywords = $('#keywordsInput').val();
                        let location = $('#locationInput').val();

                        socket.emit('search', { keywords: keywords, location: location });
                        showVisualizationMessage();
                    });
                });

                // socket.on('progress_update', handleProgressEvent);
                socket.on('existing_data_plots', handleExistingPlotData);
                // socket.on('update_plot', handleUpdatedPlotData);

                function handleExistingPlotData(data) {
                    console.log('Existing data plots received.');
                    handlePlotData(data, 'newPlot');
                }

                function handleUpdatedPlotData(data) {
                    console.log('Plot update received.');
                    handleProgressUpdate(data.state);
                    handlePlotData(data, 'react'); 
                }

                function handlePlotData(data, plotMethod) {
                if (data['top_skills_plot'] && data['top_cities_plot']) {
                    try {
                        let topSkillsPlot = JSON.parse(data['top_skills_plot']);
                        let topCitiesPlot = JSON.parse(data['top_cities_plot']);

                        if (validatePlotData(topSkillsPlot) && validatePlotData(topCitiesPlot)) {
                            hideLoader();
                            $('#topSkillsPlotContainer').show();
                            $('#topCitiesPlotContainer').show();

                            Plotly.newPlot('topSkillsPlot', topSkillsPlot.data, topSkillsPlot.layout);
                            Plotly.newPlot('topCitiesPlot', topCitiesPlot.data, topCitiesPlot.layout);
                        } else {
                            showVisualizationMessage();
                        }
                    } catch (error) {
                        console.error('Error parsing JSON data:', error);
                        showNoDataMessage();
                    }
                } else {
                    console.log('No data received.');
                    showVisualizationMessage();
                }
            }

                function validatePlotData(plotData) {
                    return typeof plotData === 'object' && plotData !== null &&
                        plotData.hasOwnProperty('data') && plotData.hasOwnProperty('layout') &&
                        Array.isArray(plotData.data) && plotData.data.length > 0;
                }

                function showLoader() {
                    $('#loader').show();
                    $('#noDataMessage').hide();
                }

                function hideLoader() {
                    $('#loader').hide();
                }

                function showNoDataMessage() {
                    $('#noDataMessage').show();
                    hideLoader();
                }

                function showVisualizationMessage() {
                    $('#visualizationMessage').show();
                }

                function hideVisualizationMessage() {
                    $('#visualizationMessage').hide();
                }
            });

    </script>
</body>

</html>

